name: Deploy to Prod

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag from dev to promote (e.g., main-abc1234)'
        required: true
        type: string
      version:
        description: 'Version tag for prod (e.g., v1.0.0)'
        required: true
        type: string

env:
  # Prod promotion is explicit: we reuse an image proven in dev, then re-tag it for prod.
  REGION: europe-west3
  DEV_PROJECT_ID: global-reach-media-dev
  PROD_PROJECT_ID: global-reach-media-prod
  SERVICE_NAME: php-app
  STATIC_BUCKET: global-reach-media-static-prod
  DOCKER_REPO: docker-repo
  # Shared actions repo ref. Prefer a tag like v1 for prod.
  ACTIONS_REF: main

jobs:
  promote-and-deploy:
    name: Promote to Prod
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # Needed for static asset upload. The container image is promoted via docker pull/tag/push.

      - name: Deploy pipeline (promote -> deploy -> smoke)
        uses: cosminmcnoprea-pixel/gh-actions/.github/actions/cloudrun-service-prod@${{ env.ACTIONS_REF }}
        with:
          workload-identity-provider: ${{ secrets.WIF_PROVIDER_PROD }}
          service-account: ${{ secrets.WIF_SERVICE_ACCOUNT_PROD }}
          region: ${{ env.REGION }}
          dev-project-id: ${{ env.DEV_PROJECT_ID }}
          prod-project-id: ${{ env.PROD_PROJECT_ID }}
          docker-repo: ${{ env.DOCKER_REPO }}
          service-name: ${{ env.SERVICE_NAME }}
          source-tag: ${{ inputs.image_tag }}
          target-tag: ${{ inputs.version }}
          static-bucket: ${{ env.STATIC_BUCKET }}
          smoke-expected: "PHP-FPM on Cloud Run"
