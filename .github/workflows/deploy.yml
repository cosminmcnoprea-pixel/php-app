name: Deploy to Dev

on:
  push:
    branches:
      - main
    # Dev deploys are automatic on main to keep the env up to date.
  workflow_dispatch:
    # Manual trigger is handy for reruns / debugging without a new commit.

env:
  # Keep env-specific envs in one place
  REGION: europe-west3
  PROJECT_ID: global-reach-media-dev
  SERVICE_NAME: php-app
  STATIC_BUCKET: global-reach-media-static-dev
  DOCKER_REPO: docker-repo
  # This points at the shared actions repo in the org.
  # Use a tag like v1 once you cut releases; `main` is fine while iterating.
  ACTIONS_REF: main

jobs:
  build-and-deploy:
    name: Build and Deploy to Dev
    runs-on: ubuntu-latest
    permissions:
      # Checkout needs this - read-only.
      contents: read
      # Required for Workload Identity Federation (OIDC) auth to GCP.
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        # Pulls the repo on the runner so we can build the container + upload static assets

      - name: Deploy pipeline (test -> build -> deploy -> smoke)
        uses: cosminmcnoprea-pixel/gh-actions/.github/actions/cloudrun-service-dev@${{ env.ACTIONS_REF }}
        with:
          workload-identity-provider: ${{ secrets.WIF_PROVIDER_DEV }}
          service-account: ${{ secrets.WIF_SERVICE_ACCOUNT_DEV }}
          region: ${{ env.REGION }}
          project-id: ${{ env.PROJECT_ID }}
          service-name: ${{ env.SERVICE_NAME }}
          docker-repo: ${{ env.DOCKER_REPO }}
          static-bucket: ${{ env.STATIC_BUCKET }}
          php-working-directory: .
          smoke-expected: "PHP-FPM on Cloud Run"
